{% extends "AppBundle::raidplanner/base.html.twig" %}

{% set map = {
'none' : 'default',
'present' : 'success',
'maybe' : 'warning',
'backup' : 'info',
} %}

{% block raidcontent %}

    {% set timenow = 'now'|date('Y-m-d 12:00:00')|date('U') %}
    {% set time = (date~'12:00:00')|date('U') %}
    {% set curtime = (curdate~'12:00:00')|date('U') %}

    <div class="panel panel-default">
        <div class="panel-heading">
            <b>{{ member.roster.name }}</b>

            <div class="pull-right">

                {% if member.canModifyRoster %}
                    <button type="button" class="btn btn-xs btn-info action-add-member">
                        {{ 'raidplanner.add_member'|trans }}
                    </button>

                    <a href="./modify-{{ member.roster.id }}" class="btn btn-xs btn-primary">
                        {{ 'raidplanner.modify'|trans }}
                    </a>
                {% endif %}

                {% if member.canDeleteRoster %}
                    <button type="button" data-href="./delete-{{ member.roster.id }}"
                            class="btn btn-xs btn-danger action-delete">
                        {{ 'raidplanner.delete'|trans }}
                    </button>
                {% endif %}

            </div>

        </div>
        <div class="panel-body">

            {% if member.roster.description %}
                <div class="well well-sm">
                    {{ member.roster.description }}
                </div>
            {% endif %}

            <table class="table table-hover table-condensed">
                <thead>
                <tr>
                    <th>
                        <a href="./detail-{{ member.roster.id }}?date={{ (time - 86400*7)|date('Y-m-d') }}"
                           class="btn btn-xs btn-primary" title="{{ 'raidplanner.week.previous'|trans }}">
                            <i class="glyphicon glyphicon-chevron-left"></i>
                        </a>
                        <div class="pull-right">
                            {% if date != curdate %}
                                <a href="./detail-{{ member.roster.id }}?date={{ curdate }}"
                                   class="btn btn-xs btn-primary" title="{{ 'raidplanner.week.current'|trans }}">
                                    <i class="glyphicon glyphicon-record"></i>
                                </a>
                            {% endif %}
                            &nbsp;
                            <a href="./detail-{{ member.roster.id }}?date={{ date }}"
                               class="btn btn-xs btn-primary" title="{{ 'raidplanner.week.refresh'|trans }}">
                                <i class="glyphicon glyphicon-refresh"></i>
                            </a>
                        </div>
                    </th>
                    {% for i in 1..7 %}
                        {% set timeday = (date~'12:00:00')|date('U') + 86400 * (i-1) %}
                        <th class="day {% if timeday < timenow %}text-muted{% endif %}">
                            {{ ('weekday.'~i)|trans }}<br/>{{ timeday|date('j/m') }}
                        </th>
                    {% endfor %}
                    <th>
                        <a href="./detail-{{ member.roster.id }}?date={{ (time + 86400*7)|date('Y-m-d') }}"
                           class="btn btn-xs btn-primary" title="{{ 'raidplanner.week.next'|trans }}">
                            <i class="glyphicon glyphicon-chevron-right"></i>
                        </a>
                    </th>
                </tr>
                </thead>
                <tbody>
                {% for memb in members %}
                    <tr data-weekid="{{ weeks[memb.id].id }}">
                        <td>
                            {% if memb.isCreator %}
                                <i class="glyphicon glyphicon-user text-danger"
                                   title="{{ 'raidplanner.creator'|trans }}"></i>
                            {% elseif memb.isOfficer %}
                                <i class="glyphicon glyphicon-user text-info"
                                   title="{{ 'raidplanner.officer'|trans }}"></i>
                            {% else %}
                                <i class="glyphicon glyphicon-user"></i>
                            {% endif %}
                            {{ memb.name }}
                        </td>
                        {% for i in 1..7 %}
                            {% set week = weeks[memb.id] %}
                            {% set status = week.getStatus(i) %}
                            {% set timeday = (date~'12:00:00')|date('U') + 86400 * (i-1) %}
                            <td class="day" data-index="{{ i }}">
                                {% if member.canModifyWeek(week) and timeday >= timenow %}
                                    <div class="btn-group">
                                        <button class="btn btn-{{ map[status] }} btn-xs dropdown-toggle"
                                                type="button" data-toggle="dropdown"
                                                aria-haspopup="true" aria-expanded="false">
                                            <span class="status">
                                                {{ ('raidplanner.status.'~status)|trans }}
                                            </span>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% for s in week.getStatusList %}
                                                <li class="status" data-status="{{ s }}">
                                                    <a href="#">{{ ('raidplanner.status.'~s)|trans }}</a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% else %}
                                    <button class="btn btn-{{ map[status] }} btn-xs" type="button" disabled="disabled">
                                        <span class="status">
                                            {{ ('raidplanner.status.'~status)|trans }}
                                        </span>
                                    </button>
                                {% endif %}
                            </td>
                        {% endfor %}
                        <td>

                        </td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                <tr>
                    <td></td>
                    {% for i in 1..7 %}
                        {% set timeday = (date~'12:00:00')|date('U') + 86400 * (i-1) %}
                        <td class="day {% if timeday < timenow %}text-muted{% endif %}">
                            {{ sums[i] ?: '' }}
                        </td>
                    {% endfor %}
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <a href="./list" class="btn btn-sm btn-default">
        <i class="glyphicon glyphicon-chevron-left"></i> {{ 'raidplanner.returnlist'|trans }}
    </a>

{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        $(function () {
            var map = {{ map|json_encode|raw }};

            $('li.status a').click(function (e) {
                var status = $(this).parents('li').data('status');
                var index = $(this).parents('td').data('index');
                var weekid = $(this).parents('tr').data('weekid');
                var $button = $(this).parents('.btn-group').find('button');
                $button.find('.status').text($(this).text());

                //
                // TODO ajax call
                //

                for (var k in map) {
                    if (typeof k === 'string') {
                        $button.removeClass('btn-' + map[k]);
                    }
                }
                $button.addClass('btn-' + (status in map ? map[status] : 'default'));
                e.stopPropagation();
                $button.dropdown('toggle');
            });
        });
    </script>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        .panel-heading .btn {
            margin-left: 1em;
        }

        tr .day {
            width: 9%;
            text-align: center;
        }

        tr th:last-child,
        tr td:last-child {
            width: 12em;
            text-align: right;
        }

        tr th:first-child,
        tr th:last-child {
            vertical-align: middle !important;
        }

        .btn.disabled, .btn[disabled] {
            cursor: default;
        }

    </style>
{% endblock %}